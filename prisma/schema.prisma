// Prisma Schema - 老人帮数据库模型
// 注意：数据库使用 camelCase 列名，需要 @map 映射

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ 用户相关 ============

// 用户表（子女）
model User {
  id          String   @id @default(cuid())
  phone       String   @unique
  name        String?
  avatar      String?
  idCard      String?  @map("idCard")
  isVerified  Boolean  @default(false) @map("isVerified")
  createdAt   DateTime @default(now()) @map("createdAt")
  updatedAt   DateTime @updatedAt @map("updatedAt")
  
  // 关联
  elderly     Elderly[]
  orders      Order[]
  
  @@map("users")
}

// 老人表
model Elderly {
  id          String   @id @default(cuid())
  name        String
  phone       String
  avatar      String?
  idCard      String?  @map("idCard")
  relation    String
  address     String
  lat         Float?
  lng         Float?
  inviteCode  String   @unique @map("inviteCode")
  healthNote  String?  @map("healthNote")
  angelNote   String?  @map("angelNote")
  createdAt   DateTime @default(now()) @map("createdAt")
  updatedAt   DateTime @updatedAt @map("updatedAt")
  
  // 关联
  userId      String   @map("userId")
  user        User     @relation(fields: [userId], references: [id])
  orders      Order[]
  
  @@map("elderly")
}

// 天使表（服务提供者）
model Angel {
  id              String   @id @default(cuid())
  phone           String   @unique
  name            String
  avatar          String?
  idCard          String?  @map("idCard")
  idCardFront     String?  @map("idCardFront")
  idCardBack      String?  @map("idCardBack")
  isVerified      Boolean  @default(false) @map("isVerified")
  status          String   @default("PENDING")
  rating          Float    @default(5.0)
  completedOrders Int      @default(0) @map("completedOrders")
  balance         Float    @default(0)
  lat             Float?
  lng             Float?
  isOnline        Boolean  @default(false) @map("isOnline")
  createdAt       DateTime @default(now()) @map("createdAt")
  updatedAt       DateTime @updatedAt @map("updatedAt")
  
  // 关联
  orders          Order[]
  incomeRecords   IncomeRecord[]
  
  @@map("angels")
}

// ============ 服务相关 ============

// 服务类型表
model ServiceType {
  id          String   @id @default(cuid())
  name        String
  icon        String
  description String
  price       Float
  unit        String
  duration    String
  category    String
  isActive    Boolean  @default(true) @map("isActive")
  sortOrder   Int      @default(0) @map("sortOrder")
  createdAt   DateTime @default(now()) @map("createdAt")
  updatedAt   DateTime @updatedAt @map("updatedAt")
  
  // 关联
  orders      Order[]
  
  @@map("service_types")
}

// ============ 订单相关 ============

// 订单表
model Order {
  id            String      @id @default(cuid())
  orderNo       String      @unique @map("orderNo")
  status        String      @default("PENDING")
  
  // 服务信息
  serviceTypeId String      @map("serviceTypeId")
  serviceType   ServiceType @relation(fields: [serviceTypeId], references: [id])
  serviceTime   DateTime    @map("serviceTime")
  address       String
  lat           Float?
  lng           Float?
  remark        String?
  
  // 费用
  price         Float
  isPaid        Boolean     @default(false) @map("isPaid")
  paidAt        DateTime?   @map("paidAt")
  paymentMethod String?     @map("paymentMethod")
  
  // 子女信息
  userId        String      @map("userId")
  user          User        @relation(fields: [userId], references: [id])
  
  // 老人信息
  elderlyId     String      @map("elderlyId")
  elderly       Elderly     @relation(fields: [elderlyId], references: [id])
  
  // 天使信息
  angelId       String?     @map("angelId")
  angel         Angel?      @relation(fields: [angelId], references: [id])
  
  // 服务进度
  acceptedAt    DateTime?   @map("acceptedAt")
  arrivedAt     DateTime?   @map("arrivedAt")
  startedAt     DateTime?   @map("startedAt")
  completedAt   DateTime?   @map("completedAt")
  cancelledAt   DateTime?   @map("cancelledAt")
  cancelReason  String?     @map("cancelReason")
  
  // 评价
  rating        Float?
  comment       String?
  
  createdAt     DateTime    @default(now()) @map("createdAt")
  updatedAt     DateTime    @updatedAt @map("updatedAt")
  
  // 关联
  timelines     OrderTimeline[]
  
  @@map("orders")
}

// 订单时间线
model OrderTimeline {
  id        String   @id @default(cuid())
  orderId   String   @map("orderId")
  order     Order    @relation(fields: [orderId], references: [id])
  event     String
  content   String
  operator  String?
  createdAt DateTime @default(now()) @map("createdAt")
  
  @@map("order_timelines")
}

// ============ 财务相关 ============

// 天使收入记录
model IncomeRecord {
  id          String   @id @default(cuid())
  angelId     String   @map("angelId")
  angel       Angel    @relation(fields: [angelId], references: [id])
  amount      Float
  type        String
  description String
  orderId     String?  @map("orderId")
  createdAt   DateTime @default(now()) @map("createdAt")
  
  @@map("income_records")
}
